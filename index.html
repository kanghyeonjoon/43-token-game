<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AG 43ê¸° ê°€ì¹˜ í† í° GAME</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* í°íŠ¸ ë° ê¸°ë³¸ ì„¤ì • */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Pretendard', 'Segoe UI', sans-serif;
            background: #fcfcfc;
            min-height: 100vh;
            padding: 20px;
            color: #333;
            overflow-x: hidden;
            position: relative;
        }

        /* ğŸ”¥ 3D ì™€ì´ì–´í”„ë ˆì„ ë°°ê²½ */
        .background-wireframe {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            pointer-events: none;
            overflow: hidden;
        }
        .geo-shape {
            position: absolute;
            border: 2px solid rgba(100, 100, 255, 0.2);
            background: transparent;
            animation: rotate3d 20s infinite linear;
        }
        .shape-tri {
            top: 10%; left: -5%; width: 400px; height: 400px;
            border-radius: 30px; border: 2px solid rgba(66, 133, 244, 0.15);
            transform: rotate(45deg); animation: floatRotate 25s infinite linear;
        }
        .shape-hex {
            bottom: 5%; right: -10%; width: 350px; height: 350px;
            border: 2px solid rgba(233, 30, 99, 0.15); border-radius: 50%;
            animation: floatRotate 30s infinite reverse linear;
        }
        .shape-cube {
            top: 30%; right: 15%; width: 100px; height: 100px;
            border: 2px solid rgba(156, 39, 176, 0.25);
            transform: rotate(15deg); animation: floatObj 8s infinite ease-in-out;
        }
        .shape-cube-2 {
            bottom: 25%; left: 10%; width: 80px; height: 80px;
            border: 2px solid rgba(0, 188, 212, 0.25);
            animation: floatObj 10s infinite ease-in-out 1s;
        }
        @keyframes floatRotate {
            0% { transform: rotate(0deg) translate(0, 0); }
            50% { transform: rotate(180deg) translate(30px, 30px); }
            100% { transform: rotate(360deg) translate(0, 0); }
        }
        @keyframes floatObj {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-40px) rotate(20deg); }
        }
        .line-grid {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(rgba(0,0,0,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.03) 1px, transparent 1px);
            background-size: 50px 50px; z-index: -2;
        }

        .container { max-width: 1000px; margin: 0 auto; padding-bottom: 80px; }
        
        /* í—¤ë” */
        .header { text-align: center; margin-bottom: 30px; position: relative; }
        .header h1 { 
            font-size: 2.4em; margin-bottom: 10px; color: #111; font-weight: 900; letter-spacing: -1px;
            background: -webkit-linear-gradient(45deg, #1a237e, #0d47a1);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .header-btns { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .header-btn { 
            background: white; border: 1px solid #e0e0e0; color: #555; 
            padding: 8px 18px; border-radius: 30px; cursor: pointer; 
            font-weight: 600; font-size: 0.85em; transition: 0.2s; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .header-btn:hover { background: #f5f5f5; color: #1a237e; border-color: #1a237e; }
        
        /* ì¹´ë“œ ê³µí†µ (ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜) */
        .card, .level-card, .pending-card, .ecosystem-card, .user-selection-card, .modal-card {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
        }

        /* ìƒíƒœê³„ ì¹´ë“œ */
        .ecosystem-card { background: white; color: #333; padding: 30px; text-align: center; margin-bottom: 25px; border-left: 5px solid #1a237e; }
        .eco-title { font-size: 0.9em; color: #666; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .eco-value { font-size: 3em; font-weight: 800; color: #1a237e; letter-spacing: -1px; }
        .eco-target { font-size: 0.9em; color: #888; margin-top: 10px; background: #f5f5f5; padding: 5px 15px; border-radius: 20px; display: inline-block; }

        /* ë©”ì¸ ê·¸ë¦¬ë“œ */
        .main-grid { display: grid; grid-template-columns: 1fr 1.5fr 1fr; gap: 20px; }
        .card { padding: 30px; }
        .card h2 { color: #111; margin-bottom: 25px; font-size: 1.3em; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        
        /* ë ˆë²¨ ì¹´ë“œ */
        .level-card { text-align: center; padding: 30px 20px; }
        .level-emoji { font-size: 4.5em; margin: 10px 0 15px; }
        .level-name { font-size: 1.8em; font-weight: 800; margin-bottom: 5px; color: #333; }
        .level-badge { background: #f0f2f5; color: #555; padding: 6px 12px; border-radius: 8px; font-size: 0.85em; font-weight: 700; }
        .level-progress-bg { background: #eee; height: 8px; border-radius: 4px; margin: 25px 0 10px; overflow: hidden; }
        .level-progress-bar { height: 100%; background: #1a237e; width: 0%; transition: width 1s; border-radius: 4px; }

        /* ë¯¸ì…˜ */
        .mission-box { margin-top: 25px; text-align: left; }
        .mission-item { margin-bottom: 15px; }
        .mission-label { font-size: 0.85em; color: #666; display: flex; justify-content: space-between; margin-bottom: 6px; font-weight: 600; }
        .mission-bar-bg { height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden; }
        .mission-bar-fill { height: 100%; background: #4caf50; width: 0%; transition: width 1s; }
        .mission-weekly .mission-bar-fill { background: #ff9800; }

        /* ëŒ€ê¸° í† í° */
        .pending-card { background: #fff8e1; border: 1px solid #ffecb3; text-align: center; padding: 25px; }
        .pending-amount { font-size: 2.2em; font-weight: 800; color: #f57c00; margin: 10px 0; }
        
        /* ë²„íŠ¼ */
        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-size: 1em; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-primary { 
            background: linear-gradient(135deg, #1a237e, #0d47a1); color: white;
            box-shadow: 0 8px 20px rgba(26, 35, 126, 0.3);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 12px 25px rgba(26, 35, 126, 0.4); }
        .btn-receive { background: #f57c00; color: white; }
        .btn-receive:hover { background: #ef6c00; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(245, 124, 0, 0.2); }
        .btn-receive:disabled { background: #e0e0e0; color: #999; cursor: not-allowed; transform: none; box-shadow: none; }

        /* í¼ */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 0.9em; color: #666; margin-bottom: 8px; font-weight: 600; }
        .amount-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .amount-btn { padding: 12px; border: 1px solid #eee; background: white; border-radius: 10px; cursor: pointer; font-weight: 600; color: #555; transition: 0.2s; }
        .amount-btn:hover { background: #f5f5f5; border-color: #ccc; }
        .amount-btn.selected { background: #1a237e; color: white; border-color: #1a237e; }
        input[type="number"], textarea { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid #e0e0e0; background: #fff; font-size: 0.95em; font-family: inherit; transition: 0.2s; }
        input:focus, textarea:focus { border-color: #1a237e; outline: none; }

        /* ë“œë¡­ë‹¤ìš´ */
        .dropdown-wrapper { position: relative; z-index: 50; }
        .dropdown-btn { 
            width: 100%; padding: 14px; border-radius: 10px; border: 1px solid #e0e0e0; 
            background: #fff; font-size: 0.95em; font-family: inherit; cursor: pointer; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .dropdown-btn:hover { border-color: #1a237e; }
        .dropdown-list { 
            position: absolute; top: 105%; left: 0; right: 0; background: #fff; border: 1px solid #eee; 
            border-radius: 12px; margin-top: 0; max-height: 250px; overflow-y: auto; z-index: 1000; 
            display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .dropdown-list.show { display: block; }
        .dropdown-item { padding: 15px; border-bottom: 1px solid #f9f9f9; cursor: pointer; font-size: 0.95em; transition: 0.1s; }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: #f0f2f5; color: #1a237e; font-weight: 600; }

        /* ë­í‚¹ íƒ­ */
        .rank-tabs { display: flex; gap: 0; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .rank-tab { flex: 1; padding: 12px; border: none; background: none; cursor: pointer; font-weight: 600; color: #999; font-size: 0.95em; position: relative; }
        .rank-tab.active { color: #1a237e; }
        .rank-tab.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 2px; background: #1a237e; }
        .rank-list { max-height: 400px; overflow-y: auto; }
        .rank-item { display: flex; justify-content: space-between; padding: 12px 5px; border-bottom: 1px solid #f5f5f5; align-items: center; }
        .rank-medal { margin-right: 10px; font-size: 1.2em; width: 25px; text-align: center; }

        /* ëª¨ë‹¬ (ì•ˆë‚´ì°½) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); z-index: 9999; display: none; align-items: center; justify-content: center; }
        .modal-card { width: 90%; max-width: 450px; padding: 40px 30px; text-align: left; background: rgba(255, 255, 255, 0.95); }
        .notice-title { color: #1a237e; font-size: 1.6em; font-weight: 900; margin-bottom: 25px; text-align: center; }
        .notice-list { list-style: none; padding: 0; }
        .notice-list li { margin-bottom: 15px; font-size: 1em; line-height: 1.6; color: #444; position: relative; padding-left: 25px; }
        .notice-list li::before { content: "âœ”"; color: #1a237e; position: absolute; left: 0; top: 2px; font-weight: bold; font-size: 1.1em; }
        .close-modal { position: absolute; top: 20px; right: 25px; font-size: 28px; cursor: pointer; color: #ccc; transition: 0.2s; }
        .close-modal:hover { color: #1a237e; }

        /* ê´€ë¦¬ì */
        .admin-section { margin-top: 40px; padding: 20px; background: transparent; border: 1px dashed #ccc; border-radius: 15px; text-align: center; }
        .admin-btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; border: none; margin: 5px; cursor: pointer; font-size: 0.85em; }

        @media (max-width: 768px) {
            .main-grid { grid-template-columns: 1fr; }
            .amount-grid { grid-template-columns: repeat(4, 1fr); }
            .header h1 { font-size: 1.8em; }
        }
        
        /* ìœ ì € ì„ íƒ ë° ë“œë¡­ë‹¤ìš´ */
        .user-selection { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding: 10px; }
        .user-select-card { 
            background: white; border: 1px solid #eee; padding: 15px; 
            border-radius: 15px; width: calc(50% - 10px); cursor: pointer; 
            text-align: center; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
        }
        .user-select-card:hover, .user-select-card.selected { border-color: #1a237e; background: #f5f5f5; }
        
        /* ğŸ”¥ ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .delete-btn {
            position: absolute; top: -8px; right: -8px;
            background: #e53935; color: white; width: 24px; height: 24px;
            border-radius: 50%; font-size: 14px; line-height: 24px;
            text-align: center; cursor: pointer; transition: 0.2s;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            z-index: 10; font-weight: bold;
        }
        .delete-btn:hover { background: #b71c1c; transform: scale(1.1); }
        
        /* ê´€ë¦¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .manage-btn {
            background: none; border: none; color: #999; font-size: 0.8em; cursor: pointer;
            padding: 5px 10px; border-radius: 5px; transition: 0.2s;
        }
        .manage-btn:hover { background: #f0f0f0; color: #333; }
        .manage-btn.active { color: #e65100; font-weight: bold; }
    </style>
</head>
<body>

    <div class="background-wireframe">
        <div class="line-grid"></div>
        <div class="geo-shape shape-tri"></div>
        <div class="geo-shape shape-hex"></div>
        <div class="geo-shape shape-cube"></div>
        <div class="geo-shape shape-cube-2"></div>
    </div>

    <div id="loginScreen" style="position: fixed; top:0; left:0; width:100%; height:100%; z-index:9000; display:flex; flex-direction:column; align-items:center; justify-content:center; overflow-y:auto; background:rgba(255,255,255,0.1); backdrop-filter:blur(5px);"> 
        <div style="width:90%; max-width:500px; text-align:center; padding:20px;">
            <h1 style="color:#1a237e; margin-bottom:10px; font-weight:900; text-shadow: 2px 2px 4px rgba(255,255,255,0.8);">AG 43ê¸°<br>ê°€ì¹˜ í† í° GAME</h1>
            <p style="color:#333; margin-bottom:30px; font-weight:700; text-shadow: 1px 1px 2px rgba(255,255,255,0.8);">ë‹¹ì‹ ì˜ ê°€ì¹˜ë¥¼ ì¦ëª…í•˜ê³  ì¸ì •ë°›ìœ¼ì„¸ìš”!</p>
            
            <div id="userListArea" class="user-selection-card" style="background:rgba(255,255,255,0.9); padding:30px; border-radius:24px; box-shadow:0 20px 50px rgba(0,0,0,0.1);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="margin:0;">ğŸ‘¤ ì°¸ê°€ì ì„ íƒ</h3>
                    <button class="manage-btn" id="adminToggleBtn" onclick="toggleAdminMode()">âš™ï¸ ê´€ë¦¬</button>
                </div>
                <div id="userGrid" class="user-selection"></div>
                <button class="btn btn-primary" id="startBtn" onclick="startGame()" disabled style="margin-top:25px;">ì„ íƒí•œ ê³„ì •ìœ¼ë¡œ ì‹œì‘</button>
                <p style="margin-top:20px; font-size:0.9em; color:#666; cursor:pointer; text-decoration:underline;" onclick="toggleRegister()">â• ë‚´ ì´ë¦„ì´ ì—†ë‚˜ìš”? ìƒˆë¡œ ë“±ë¡í•˜ê¸°</p>
            </div>

            <div id="registerArea" class="user-selection-card" style="background:rgba(255,255,255,0.9); padding:30px; border-radius:24px; box-shadow:0 20px 50px rgba(0,0,0,0.1); display:none;">
                <h3 style="margin-bottom:20px;">âœ¨ ìƒˆ ì°¸ê°€ì ë“±ë¡</h3>
                <input type="text" id="regName" placeholder="ì´ë¦„ (ì˜ˆ: ê¹€ì„±ì¥)" style="width:100%; padding:15px; border:1px solid #ddd; border-radius:12px; margin-bottom:10px;">
                <input type="text" id="regProduct" placeholder="ì œê³µ ê°€ì¹˜ (ì˜ˆ: ê¸ì • ì—ë„ˆì§€)" style="width:100%; padding:15px; border:1px solid #ddd; border-radius:12px; margin-bottom:20px;">
                <button class="btn btn-primary" onclick="registerUser()">ë“±ë¡í•˜ê³  ì‹œì‘</button>
                <p style="margin-top:20px; font-size:0.9em; color:#666; cursor:pointer;" onclick="toggleRegister()">ğŸ”™ ëŒì•„ê°€ê¸°</p>
            </div>
        </div>
    </div>

    <div id="gameScreen" class="container" style="display:none;">
        <div class="header">
            <h1>AG 43ê¸° ê°€ì¹˜ í† í°</h1>
            <div class="header-btns">
                <button class="header-btn" onclick="openGuide()">ğŸ“– ê²Œì„ ê°€ì´ë“œ</button>
                <button class="header-btn" onclick="logout()">ğŸ”“ ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="ecosystem-card">
            <div class="eco-title">ğŸŒ AG 43ê¸° ìƒíƒœê³„ ì´ ìœ í†µëŸ‰</div>
            <div class="eco-value" id="totalEcosystem">0ë§Œì›</div>
            <div class="eco-target">ğŸ¯ ëª©í‘œ: 1ì–µ ë‹¬ì„±ê¹Œì§€ <span id="remainTarget">0</span>ë§Œì› ë‚¨ìŒ</div>
        </div>

        <div class="main-grid">
            <div>
                <div class="card level-card">
                    <div class="level-emoji" id="myEmoji">ğŸŒ±</div>
                    <div class="level-name" id="myName">ì´ë¦„</div>
                    <span class="level-badge" id="myLevel">Lv.1 ìƒˆì‹¹</span>
                    <div class="level-progress-bg">
                        <div class="level-progress-bar" id="expBar"></div>
                    </div>
                    <div style="font-size:0.85em; color:#888;" id="nextLevelText">ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ 100ë§Œì›</div>
                    <div class="mission-box">
                        <div class="mission-item">
                            <div class="mission-label"><span>ğŸ“… ì˜¤ëŠ˜ ëª©í‘œ (10ë§Œ)</span><span id="dailyText">0%</span></div>
                            <div class="mission-bar-bg"><div class="mission-bar-fill" id="dailyBar"></div></div>
                        </div>
                        <div class="mission-item mission-weekly">
                            <div class="mission-label"><span>ğŸ“† ì£¼ê°„ ëª©í‘œ (70ë§Œ)</span><span id="weeklyText">0%</span></div>
                            <div class="mission-bar-bg"><div class="mission-bar-fill" id="weeklyBar"></div></div>
                        </div>
                    </div>
                </div>

                <div class="card pending-card" style="margin-top:15px;">
                    <h3 style="color:#e65100; font-size:1em;">ğŸ’° ë°›ê¸° ëŒ€ê¸°</h3>
                    <div class="pending-amount" id="pendingAmount">0ë§Œì›</div>
                    <div id="pendingList" style="text-align:left; font-size:0.85em; color:#666; margin-bottom:15px; max-height:100px; overflow-y:auto;"></div>
                    <button class="btn btn-receive" id="receiveBtn" onclick="receiveAll()" disabled>ğŸ™ ê°ì‚¬íˆ ë°›ê¸°</button>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ ê°€ì¹˜ ì¸ì • í† í° ë°œí–‰</h2>
                <p style="font-size:0.9em; color:#666; margin-bottom:20px;">ì¤‘ì•™ì€í–‰ì²˜ëŸ¼ ì‹ ë‚˜ê²Œ ê°€ì¹˜ë¥¼ ë°œí–‰í•˜ì„¸ìš”! (1íšŒ ìµœëŒ€ 10ë§Œì›)</p>
                <form onsubmit="issueToken(event)">
                    <div class="form-group">
                        <label class="form-label">ëˆ„êµ¬ì˜ ê°€ì¹˜ë¥¼ ì¸ì •í•˜ë‚˜ìš”?</label>
                        <input type="hidden" id="targetUserId">
                        <div class="dropdown-wrapper">
                            <div class="dropdown-btn" onclick="toggleDropdown()">
                                <span id="targetName">ì„ íƒí•˜ì„¸ìš”</span> <span>â–¼</span>
                            </div>
                            <div class="dropdown-list" id="userDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ê¸ˆì•¡ ì„ íƒ (ë§Œì›)</label>
                        <div class="amount-grid">
                            <div class="amount-btn" onclick="selectAmount(3)">3ë§Œ</div>
                            <div class="amount-btn" onclick="selectAmount(5)">5ë§Œ</div>
                            <div class="amount-btn" onclick="selectAmount(7)">7ë§Œ</div>
                            <div class="amount-btn" onclick="selectAmount(10)">10ë§Œ</div>
                        </div>
                        <input type="number" id="customAmount" placeholder="ì§ì ‘ ì…ë ¥ (ìµœëŒ€ 10)" style="margin-top:10px;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì–´ë–¤ ì ì´ í›Œë¥­í–ˆë‚˜ìš”? (ì¹­ì°¬ ë¦´ë ˆì´)</label>
                        <textarea id="message" placeholder="ë©”ì´íŠ¸ì˜ ë¹›ë‚˜ëŠ” ì¥ì , ìˆ¨ì€ ê°€ëŠ¥ì„±ì„ ì°¾ì•„ ì¹­ì°¬í•´ì£¼ì„¸ìš”! âœ¨" style="height:80px; resize:none;"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">ğŸª™ í† í° ë°œí–‰í•˜ê¸°</button>
                </form>
            </div>

            <div class="card">
                <h2>ğŸ† ê¸°ì—¬ ìˆœìœ„</h2>
                <div class="rank-tabs">
                    <button class="rank-tab active" onclick="switchTab('weekly')" id="tab-weekly">ì£¼ê°„</button>
                    <button class="rank-tab" onclick="switchTab('monthly')" id="tab-monthly">ì›”ê°„</button>
                    <button class="rank-tab" onclick="switchTab('total')" id="tab-total">ëˆ„ì </button>
                </div>
                <div class="rank-list" id="rankingList"></div>
                <h2 style="margin-top:30px; font-size:1.2em;">ğŸ“¡ ì‹¤ì‹œê°„ í™œë™</h2>
                <div id="activityFeed" style="font-size:0.9em; color:#555; max-height:250px; overflow-y:auto;"></div>
            </div>
        </div>

        <div class="admin-section">
            <h3 style="margin-bottom:10px; color:#555;">ğŸ› ï¸ ìš´ì˜ì§„ ë©”ë‰´</h3>
            <button class="admin-btn" style="background:#5c6bc0; color:white;" onclick="adminReset('weekly')">ì£¼ê°„ ì´ˆê¸°í™”</button>
            <button class="admin-btn" style="background:#3949ab; color:white;" onclick="adminReset('monthly')">ì›”ê°„ ì´ˆê¸°í™”</button>
            <button class="admin-btn" style="background:#d32f2f; color:white;" onclick="adminReset('all')">ğŸ’€ ì‹œì¦Œ ì™„ì „ ì´ˆê¸°í™”</button>
            <button class="admin-btn" style="background:#4caf50; color:white; margin-top:10px;" onclick="downloadBackupData()">ğŸ“¥ ë°ì´í„° ë°±ì—… (ë‹¤ìš´ë¡œë“œ)</button>
        </div>
    </div>

    <div class="modal-overlay" id="guideModal">
        <div class="modal-card">
            <span class="close-modal" onclick="closeGuide()">&times;</span>
            <div class="notice-title">AG 43ê¸° ê°€ì¹˜ í† í° GAME</div>
            <ul class="notice-list">
                <li><strong>í† í° ë°œí–‰ ê°œì‹œ:</strong> 2025.11.24(ì›”) 00:00 ~</li>
                <li><strong>ê¸°ì—¬ ìˆœìœ„:</strong> ì£¼ê°„, ì›”ê°„, ëˆ„ì  (ì‹¤ì‹œê°„ ë°˜ì˜)</li>
                <li><strong>í•„ìˆ˜ ë¯¸ì…˜:</strong> ê°€ì¹˜ ì¸ì • í† í° ë°œí–‰í•˜ê¸°<br> - ìµœì†Œ: 1ì¼ 10ë§Œì› / 1ì£¼ 70ë§Œì› ì´ìƒ</li>
                <li><strong>ì‹œì¦Œ ëª©í‘œ:</strong> 43ê¸° ìƒíƒœê³„ í†µí™”ëŸ‰ 1ì–µ ì´ìƒ ë‹¬ì„±! ğŸš€</li>
                <li>ë°›ì€ í† í°ì€ "ê°ì‚¬íˆ ë°›ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ ìˆ˜ë ¹í•˜ì„¸ìš”!</li>
            </ul>
            <div style="text-align:center; margin-top:30px;">
                <button class="btn btn-primary" onclick="closeGuide()" style="padding:15px 30px; font-size:1.1em;">í™•ì¸í–ˆìŠµë‹ˆë‹¤! Game Start ğŸ”¥</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://kyicedypelnrnctkvicq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_GYfuzyBClnj4jHILADklcg_wsxlt2ZV';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let allUsers = [];
        let currentRankType = 'weekly';
        let selectedAmt = 0;
        let isAdminMode = false;

        const levels = [
            { min: 0, name: 'ìƒˆì‹¹', emoji: 'ğŸŒ±' },
            { min: 100, name: 'ì„±ì¥', emoji: 'ğŸŒ¿' },
            { min: 300, name: 'ìˆ™ë ¨', emoji: 'ğŸŒ³' },
            { min: 500, name: 'ì „ë¬¸', emoji: 'ğŸ’¼' },
            { min: 1000, name: 'ë§ˆìŠ¤í„°', emoji: 'ğŸ‘‘' }
        ];

        async function init() {
            await fetchUsers();
            setupRealtime();
            const savedId = localStorage.getItem('ag43_user_id');
            if (savedId) {
                const user = allUsers.find(u => u.user_id === savedId);
                if (user) {
                    tempUser = user;
                    startGame(false); 
                } else {
                    document.getElementById('loginScreen').style.display = 'flex';
                }
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
            }
        }

        function setupRealtime() {
            supabase.channel('public:user_data').on('postgres_changes', { event: '*', schema: 'public', table: 'user_data' }, () => {
                fetchUsers(true);
            }).subscribe();
            supabase.channel('public:activities').on('postgres_changes', { event: '*', schema: 'public', table: 'activities' }, (payload) => {
                loadActivities();
                if (payload.eventType === 'INSERT') {
                    if (currentUser && (payload.new.user_id === currentUser.user_id || payload.new.message.includes(currentUser.name))) {
                        loadMyData();
                    }
                }
            }).subscribe();
        }

        async function fetchUsers(silent = false) {
            const { data, error } = await supabase.from('user_data').select('*');
            if (error) { console.error(error); return; }
            allUsers = data;
            if (!silent) renderUserSelection();
            renderRanking(); renderDropdown(); updateEcosystem();
            if (currentUser) {
                const updatedMe = allUsers.find(u => u.user_id === currentUser.user_id);
                if (updatedMe) { currentUser = updatedMe; updateMyUI(); }
            }
        }

        function renderUserSelection() {
            const grid = document.getElementById('userGrid');
            grid.innerHTML = '';
            allUsers.sort((a,b) => a.name.localeCompare(b.name)).forEach(u => {
                const deleteBtn = isAdminMode ? `<div class="delete-btn" onclick="deleteUser('${u.user_id}', '${u.name}'); event.stopPropagation();">X</div>` : '';
                
                const div = document.createElement('div');
                div.className = 'user-select-card';
                if(isAdminMode) div.style.border = "2px solid #ff9800";
                
                div.innerHTML = `${deleteBtn}<div style="font-size:1.2em; font-weight:bold;">${u.name}</div><div style="font-size:0.8em; color:#666;">${u.product}</div>`;
                
                div.onclick = () => {
                    if(isAdminMode) editUser(u.user_id, u.name, u.product);
                    else selectLoginUser(u);
                };
                grid.appendChild(div);
            });
        }

        let tempUser = null;
        function selectLoginUser(user) {
            tempUser = user;
            document.querySelectorAll('.user-select-card').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            const btn = document.getElementById('startBtn');
            btn.disabled = false;
            btn.innerText = `[${user.name}] ë‹˜ìœ¼ë¡œ ì‹œì‘í•˜ê¸°`;
        }

        function startGame(showGuide = true) {
            if (!tempUser) return;
            currentUser = tempUser;
            localStorage.setItem('ag43_user_id', currentUser.user_id);
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            loadMyData(); loadActivities();
            if(showGuide) openGuide();
        }

        function logout() {
            if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem('ag43_user_id');
                location.reload();
            }
        }
        
        async function loadMyData() {
            const { data: pendings } = await supabase.from('pending_tokens').select('*').eq('to_user_id', currentUser.user_id);
            const totalPending = pendings.reduce((sum, item) => sum + item.amount, 0);
            document.getElementById('pendingAmount').innerText = `${totalPending}ë§Œì›`;
            document.getElementById('receiveBtn').disabled = totalPending === 0;
            const listDiv = document.getElementById('pendingList');
            listDiv.innerHTML = pendings.map(p => `<div>â€¢ ${p.from_name}ë‹˜: ${p.amount}ë§Œì› "${p.note}"</div>`).join('');
            updateMyUI();
        }

        function updateMyUI() {
            if (!currentUser) return;
            const score = currentUser.received || 0;
            let myLvl = levels[0];
            let nextScore = 100;
            for (let i = 0; i < levels.length; i++) {
                if (score >= levels[i].min) { myLvl = levels[i]; nextScore = levels[i+1] ? levels[i+1].min : score; }
            }
            document.getElementById('myEmoji').innerText = myLvl.emoji;
            document.getElementById('myName').innerText = currentUser.name;
            document.getElementById('myLevel').innerText = `Lv.${levels.indexOf(myLvl)+1} ${myLvl.name}`;
            const progress = Math.min(100, (score / nextScore) * 100);
            document.getElementById('expBar').style.width = `${progress}%`;
            document.getElementById('nextLevelText').innerText = `ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ ${nextScore - score}ë§Œì›`;
            
            const dailyGoal = 10; const weeklyGoal = 70;
            const dailyProg = Math.min(100, ((currentUser.daily_given || 0) / dailyGoal) * 100);
            const weeklyProg = Math.min(100, ((currentUser.weekly_given || 0) / weeklyGoal) * 100);
            document.getElementById('dailyBar').style.width = `${dailyProg}%`;
            document.getElementById('dailyText').innerText = `${currentUser.daily_given || 0}ë§Œ / 10ë§Œ`;
            document.getElementById('weeklyBar').style.width = `${weeklyProg}%`;
            document.getElementById('weeklyText').innerText = `${currentUser.weekly_given || 0}ë§Œ / 70ë§Œ`;
        }

        function updateEcosystem() {
            const total = allUsers.reduce((sum, u) => sum + (u.received || 0), 0);
            document.getElementById('totalEcosystem').innerText = `${total.toLocaleString()}ë§Œì›`;
            const remain = 10000 - total;
            document.getElementById('remainTarget').innerText = remain > 0 ? remain.toLocaleString() : "ë‹¬ì„± ì™„ë£Œ! ğŸ‰";
        }

        async function issueToken(e) {
            e.preventDefault();
            const targetId = document.getElementById('targetUserId').value;
            const amount = parseInt(document.getElementById('customAmount').value) || selectedAmt;
            const msg = document.getElementById('message').value;
            if (!targetId || !amount) return alert("ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            if (amount > 10) return alert("ìµœëŒ€ 10ë§Œì›ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤!");
            try {
                await supabase.from('pending_tokens').insert({ to_user_id: targetId, from_user_id: currentUser.user_id, from_name: currentUser.name, amount: amount, note: msg });
                const updates = { given: (currentUser.given || 0) + amount, weekly_given: (currentUser.weekly_given || 0) + amount, daily_given: (currentUser.daily_given || 0) + amount, monthly_given: (currentUser.monthly_given || 0) + amount };
                await supabase.from('user_data').update(updates).eq('user_id', currentUser.user_id);
                const targetName = document.getElementById('targetName').innerText;
                await supabase.from('activities').insert({ user_id: currentUser.user_id, message: `${currentUser.name}ë‹˜ì´ ${targetName}ë‹˜ì—ê²Œ ${amount}ë§Œì› ë°œí–‰! "${msg}"` });
                alert("ë°œí–‰ ì™„ë£Œ! ğŸš€"); document.getElementById('message').value = ''; document.getElementById('customAmount').value = ''; selectedAmt = 0; document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('selected'));
            } catch (err) { console.error(err); alert("ì˜¤ë¥˜ ë°œìƒ"); }
        }

        async function receiveAll() {
            if (!confirm("ëª¨ë“  í† í°ì„ ìˆ˜ë ¹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try {
                const { data: pendings } = await supabase.from('pending_tokens').select('*').eq('to_user_id', currentUser.user_id);
                const total = pendings.reduce((sum, p) => sum + p.amount, 0);
                await supabase.from('pending_tokens').delete().eq('to_user_id', currentUser.user_id);
                const updates = { received: (currentUser.received || 0) + total, weekly_received: (currentUser.weekly_received || 0) + total, daily_received: (currentUser.daily_received || 0) + total, monthly_received: (currentUser.monthly_received || 0) + total };
                await supabase.from('user_data').update(updates).eq('user_id', currentUser.user_id);
                await supabase.from('activities').insert({ user_id: currentUser.user_id, message: `${currentUser.name}ë‹˜ì´ ${total}ë§Œì›ì„ ê°ì‚¬íˆ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤! ğŸ’°` });
                alert(`${total}ë§Œì› ìˆ˜ë ¹ ì™„ë£Œ!`); loadMyData();
            } catch (err) { console.error(err); alert("ì˜¤ë¥˜ ë°œìƒ"); }
        }

        function toggleDropdown() { document.getElementById('userDropdown').classList.toggle('show'); }
        function renderDropdown() {
            const list = document.getElementById('userDropdown'); list.innerHTML = '';
            allUsers.filter(u => u.user_id !== currentUser?.user_id).forEach(u => {
                const item = document.createElement('div'); item.className = 'dropdown-item';
                item.innerHTML = `<b>${u.name}</b> <span style="font-size:0.8em; color:#888;">${u.product}</span>`;
                item.onclick = () => { document.getElementById('targetUserId').value = u.user_id; document.getElementById('targetName').innerText = u.name; list.classList.remove('show'); };
                list.appendChild(item);
            });
        }
        function selectAmount(amt) { selectedAmt = amt; document.getElementById('customAmount').value = ''; document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('selected')); event.target.classList.add('selected'); }
        function switchTab(type) { currentRankType = type; document.querySelectorAll('.rank-tab').forEach(b => b.classList.remove('active')); document.getElementById(`tab-${type}`).classList.add('active'); renderRanking(); }
        
        function renderRanking() {
            const list = document.getElementById('rankingList'); list.innerHTML = '';
            let sortKey = 'received';
            if (currentRankType === 'weekly') sortKey = 'weekly_received';
            if (currentRankType === 'monthly') sortKey = 'monthly_received';
            const sorted = [...allUsers].sort((a, b) => (b[sortKey] || 0) - (a[sortKey] || 0));
            sorted.forEach((u, idx) => {
                const div = document.createElement('div'); div.className = 'rank-item';
                let medal = idx + 1; if (idx === 0) medal = 'ğŸ¥‡'; if (idx === 1) medal = 'ğŸ¥ˆ'; if (idx === 2) medal = 'ğŸ¥‰';
                div.innerHTML = `<div style="display:flex; align-items:center;"><span class="rank-medal">${medal}</span><div><div style="font-weight:bold;">${u.name}</div><div style="font-size:0.8em; color:#888;">${u.product}</div></div></div><div style="font-weight:bold; color:#1a237e;">${(u[sortKey] || 0).toLocaleString()}ë§Œ</div>`;
                list.appendChild(div);
            });
        }

        async function loadActivities() {
            const { data } = await supabase.from('activities').select('*').order('created_at', { ascending: false }).limit(20);
            const feed = document.getElementById('activityFeed'); feed.innerHTML = '';
            if(data && data.length > 0) data.forEach(addActivityToFeed);
            else feed.innerHTML = '<div style="text-align:center; padding:20px;">í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
        function addActivityToFeed(act) {
            const feed = document.getElementById('activityFeed');
            if(feed.innerText.includes('í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤')) feed.innerHTML = '';
            const div = document.createElement('div'); div.style.padding = '8px 0'; div.style.borderBottom = '1px dashed #eee';
            const time = new Date(act.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            div.innerHTML = `<span style="color:#999; margin-right:5px;">[${time}]</span> ${act.message}`;
            feed.prepend(div);
        }

        function toggleRegister() { const list = document.getElementById('userListArea'); const reg = document.getElementById('registerArea'); if (list.style.display === 'none') { list.style.display = 'block'; reg.style.display = 'none'; } else { list.style.display = 'none'; reg.style.display = 'block'; } }
        async function registerUser() {
            const name = document.getElementById('regName').value; const product = document.getElementById('regProduct').value;
            if (!name || !product) return alert("ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            const newId = 'user_' + Date.now();
            await supabase.from('user_data').insert({ user_id: newId, name, product });
            alert("ë“±ë¡ ì™„ë£Œ!"); toggleRegister(); fetchUsers();
        }

        function openGuide() { document.getElementById('guideModal').style.display = 'flex'; }
        function closeGuide() { document.getElementById('guideModal').style.display = 'none'; }

        // ê´€ë¦¬ì ê¸°ëŠ¥
        function toggleAdminMode() {
            isAdminMode = !isAdminMode;
            const btn = document.getElementById('adminToggleBtn');
            if(isAdminMode) { btn.innerText = "âœ… ì™„ë£Œ"; btn.classList.add('active'); } 
            else { btn.innerText = "âš™ï¸ ê´€ë¦¬"; btn.classList.remove('active'); }
            renderUserSelection();
        }

        async function deleteUser(id, name) {
            if(!confirm(`ì •ë§ë¡œ ${name} ë‹˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            // ğŸ”¥ 2ì°¨ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
            const pw = prompt(`[${name}] ë‹˜ì„ ì˜êµ¬ ì‚­ì œí•˜ë ¤ë©´ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`);
            if(pw !== 'admin0000') { alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. ì‚­ì œ ì·¨ì†Œë¨."); return; }

            await supabase.from('user_data').delete().eq('user_id', id);
            await supabase.from('pending_tokens').delete().eq('to_user_id', id);
            alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); fetchUsers();
        }

        // ğŸ”¥ ì •ë³´ ìˆ˜ì • ê¸°ëŠ¥
        async function editUser(id, oldName, oldProd) {
            const newName = prompt("ì´ë¦„ ìˆ˜ì •:", oldName); if(newName===null) return;
            const newProd = prompt("ì§ì—… ìˆ˜ì •:", oldProd); if(newProd===null) return;
            await supabase.from('user_data').update({name:newName, product:newProd}).eq('user_id', id);
            alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); fetchUsers();
        }

        async function adminReset(type) {
            let pw = "";
            if(type === 'all') {
                pw = prompt("ğŸ’€ ì‹œì¦Œ ì™„ì „ ì´ˆê¸°í™” ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
                if(pw !== 'admin0000') return alert("ë¹„ë²ˆ í‹€ë¦¼");
            } else {
                pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
                if(pw !== 'aground') return alert("ë¹„ë²ˆ í‹€ë¦¼");
            }

            if (!confirm(`ì •ë§ë¡œ [${type}] ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            let updates = {};
            if (type === 'weekly') updates = { weekly_received: 0, weekly_given: 0, daily_received: 0, daily_given: 0 };
            else if (type === 'monthly') updates = { monthly_received: 0, monthly_given: 0 };
            else if (type === 'all') updates = { received: 0, given: 0, weekly_received: 0, weekly_given: 0, monthly_received: 0, monthly_given: 0, daily_received: 0, daily_given: 0 };

            await supabase.from('user_data').update(updates).neq('user_id', 'xxxx');
            if(type === 'all') {
                await supabase.from('pending_tokens').delete().neq('id', 0);
                await supabase.from('activities').delete().neq('id', 0);
                document.getElementById('activityFeed').innerHTML = '<div style="text-align:center; padding:20px;">í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            }

            // ğŸ”¥ ì¦‰ì‹œ ê²Œì´ì§€ ì´ˆê¸°í™” (ë‚´ í™”ë©´)
            if (currentUser) {
                if(type === 'weekly') {
                    currentUser.weekly_given = 0; currentUser.daily_given = 0;
                } else if(type === 'monthly') {
                    currentUser.monthly_given = 0; 
                } else if(type === 'all') {
                    currentUser.received=0; currentUser.given=0; 
                    currentUser.weekly_given=0; currentUser.daily_given=0;
                }
                updateMyUI();
            }

            alert("ì´ˆê¸°í™” ì™„ë£Œ"); fetchUsers();
        }

        // ğŸ”¥ ë°ì´í„° ë°±ì—… ê¸°ëŠ¥
        async function downloadBackupData() {
            const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (pw !== 'admin0000') return alert("ë¹„ë²ˆ í‹€ë¦¼");

            const { data: users } = await supabase.from('user_data').select('*');
            const { data: pendings } = await supabase.from('pending_tokens').select('*');
            const { data: activities } = await supabase.from('activities').select('*');

            const backupData = { users, pendings, activities, date: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `AG43_Backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        init();
    </script>
</body>
</html>