<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AG 43ê¸° ê°€ì¹˜ í† í° GAME</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f8fafc; --bg-card: rgba(255, 255, 255, 0.85); --border-subtle: rgba(0, 0, 0, 0.06);
            --border-default: rgba(0, 0, 0, 0.1); --text-primary: #1e293b; --text-secondary: #475569; --text-muted: #94a3b8;
            --accent-primary: #6366f1; --accent-secondary: #818cf8; --accent-glow: rgba(99, 102, 241, 0.15);
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #d946ef 100%);
            --gradient-gold: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            --gradient-legend: linear-gradient(135deg, #fbbf24 0%, #f59e0b 30%, #ef4444 70%, #ec4899 100%);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.08); --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.12);
            --radius-md: 12px; --radius-lg: 16px; --radius-xl: 24px;
            --transition-base: 0.25s ease;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        
        .bg-pattern { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 30%, #fce7f3 60%, #ecfeff 100%); }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 24px; padding-bottom: 100px; }
        .header { text-align: center; margin-bottom: 40px; padding-top: 20px; }
        .header h1 { font-family: 'Outfit', sans-serif; font-size: clamp(1.8rem, 5vw, 2.5rem); font-weight: 800;
            background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 20px; }
        .header-actions { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }
        .header-btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: white;
            border: 1px solid var(--border-default); border-radius: var(--radius-lg); color: var(--text-secondary);
            font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: var(--transition-base); }
        .header-btn:hover { background: rgba(99, 102, 241, 0.08); color: var(--accent-primary); transform: translateY(-3px); }

        .ecosystem-card { background: var(--bg-card); backdrop-filter: blur(20px); border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl); padding: 40px 32px; margin-bottom: 32px; text-align: center; position: relative; }
        .ecosystem-card::before { content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 60%; height: 3px; background: var(--gradient-primary); border-radius: 3px; }
        .eco-label { font-size: 0.875rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 8px; }
        .eco-value { font-family: 'Outfit', sans-serif; font-size: clamp(2.5rem, 8vw, 4rem); font-weight: 800;
            background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .eco-target { margin-top: 12px; font-size: 0.9rem; color: var(--text-secondary); }
        .eco-target span { color: var(--accent-secondary); font-weight: 600; }

        .main-grid { display: grid; grid-template-columns: 1fr 1.5fr 1fr; gap: 24px; }
        @media (max-width: 1024px) { .main-grid { grid-template-columns: 1fr 1fr; } .main-grid > div:nth-child(3) { grid-column: 1 / -1; } }
        @media (max-width: 768px) { .main-grid { grid-template-columns: 1fr; } }

        .card { background: var(--bg-card); backdrop-filter: blur(20px); border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl); padding: 28px; transition: var(--transition-base); box-shadow: var(--shadow-md); }
        .card:hover { border-color: rgba(99, 102, 241, 0.2); transform: translateY(-2px); }
        .card-title { font-size: 1rem; font-weight: 600; margin-bottom: 24px; display: flex; align-items: center; gap: 10px; }
        .card-title-icon { width: 32px; height: 32px; background: var(--accent-glow); border-radius: 8px;
            display: flex; align-items: center; justify-content: center; font-size: 1rem; }

        .profile-card { text-align: center; position: relative; }
        .profile-card::before { content: ''; position: absolute; top: -1px; left: 20%; right: 20%; height: 3px;
            background: var(--gradient-primary); border-radius: 3px; }
        .profile-emoji { font-size: 4.5rem; margin-bottom: 16px; animation: emojiFloat 4s ease-in-out infinite; }
        @keyframes emojiFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .profile-name { font-family: 'Outfit', sans-serif; font-size: 1.6rem; font-weight: 700; margin-bottom: 10px; }
        .profile-badge { display: inline-flex; align-items: center; gap: 6px; padding: 8px 18px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.25); border-radius: 100px; font-size: 0.85rem; font-weight: 600; color: var(--accent-primary); }
        
        /* ë ˆë²¨ë³„ ë±ƒì§€ ìŠ¤íƒ€ì¼ */
        .profile-badge.level-6 { background: linear-gradient(135deg, rgba(0, 188, 212, 0.15), rgba(6, 182, 212, 0.1)); border-color: rgba(0, 188, 212, 0.4); color: #0891b2; }
        .profile-badge.level-7 { background: linear-gradient(135deg, rgba(233, 30, 99, 0.15), rgba(236, 72, 153, 0.1)); border-color: rgba(233, 30, 99, 0.4); color: #db2777; }
        .profile-badge.level-8 { background: linear-gradient(135deg, rgba(96, 125, 139, 0.15), rgba(71, 85, 105, 0.1)); border-color: rgba(96, 125, 139, 0.4); color: #475569; }
        .profile-badge.level-9 { background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(139, 92, 246, 0.1)); border-color: rgba(168, 85, 247, 0.4); color: #7c3aed; }
        .profile-badge.level-10 { background: var(--gradient-legend); border-color: rgba(251, 191, 36, 0.6); color: white;
            animation: legendGlow 2s ease-in-out infinite alternate; box-shadow: 0 0 20px rgba(251, 191, 36, 0.4); }
        @keyframes legendGlow { from { box-shadow: 0 0 15px rgba(251, 191, 36, 0.4); } to { box-shadow: 0 0 30px rgba(251, 191, 36, 0.6); } }

        .progress-section { margin-top: 24px; }
        .progress-label { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px; }
        .progress-bar { height: 6px; background: rgba(255,255,255,0.95); border-radius: 100px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--gradient-primary); border-radius: 100px; transition: width 0.8s; }
        .next-level-text { font-size: 0.8rem; color: var(--text-muted); margin-top: 8px; }

        .mission-box { margin-top: 28px; padding-top: 24px; border-top: 1px solid var(--border-subtle); }
        .mission-item { margin-bottom: 20px; }
        .mission-label { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 8px; }
        .mission-bar { height: 4px; background: rgba(255,255,255,0.95); border-radius: 100px; overflow: hidden; }
        .mission-fill { height: 100%; border-radius: 100px; transition: width 0.8s; }
        .mission-fill.daily { background: var(--success); }
        .mission-fill.weekly { background: var(--warning); }

        .pending-card { background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.05));
            border-color: rgba(245, 158, 11, 0.25); margin-top: 20px; position: relative; }
        .pending-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--gradient-gold); }
        .pending-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .pending-icon { width: 36px; height: 36px; background: rgba(245, 158, 11, 0.2); border-radius: 8px;
            display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        .pending-title { font-size: 0.9rem; font-weight: 600; color: var(--warning); }
        .pending-amount { font-family: 'Outfit', sans-serif; font-size: 2rem; font-weight: 700; color: var(--warning); margin-bottom: 12px; }
        .pending-list { font-size: 0.8rem; color: var(--text-muted); max-height: 80px; overflow-y: auto; margin-bottom: 16px; }

        .btn { width: 100%; padding: 14px 24px; border-radius: var(--radius-md); border: none; font-size: 0.9rem; font-weight: 600;
            cursor: pointer; transition: var(--transition-base); display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--gradient-primary); color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.35); }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4); }
        .btn-receive { background: var(--gradient-gold); color: #1a1a1a; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.35); }
        .btn-receive:hover { transform: translateY(-3px); }
        .btn-receive:disabled { background: #e2e8f0; color: #94a3b8; cursor: not-allowed; box-shadow: none; transform: none; }

        .form-group { margin-bottom: 24px; }
        .form-label { display: block; font-size: 0.85rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 10px; }
        .amount-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .amount-btn { padding: 14px 8px; background: white; border: 1px solid var(--border-subtle); border-radius: var(--radius-md);
            color: var(--text-secondary); font-family: 'Outfit', sans-serif; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: var(--transition-base); }
        .amount-btn:hover { border-color: rgba(99, 102, 241, 0.4); color: var(--accent-primary); transform: translateY(-2px); }
        .amount-btn.selected { background: var(--gradient-primary); border-color: transparent; color: white; }

        input[type="number"], input[type="text"], textarea { width: 100%; padding: 14px 16px; background: white;
            border: 1px solid var(--border-default); border-radius: var(--radius-md); font-family: inherit; font-size: 0.9rem; outline: none; }
        input:focus, textarea:focus { border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        textarea { resize: none; min-height: 100px; }

        .dropdown-wrapper { position: relative; z-index: 50; }
        .dropdown-btn { width: 100%; padding: 14px 16px; background: white; border: 1px solid var(--border-default);
            border-radius: var(--radius-md); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .dropdown-list { position: absolute; top: calc(100% + 8px); left: 0; right: 0; background: white;
            border: 1px solid var(--border-default); border-radius: var(--radius-md); max-height: 240px; overflow-y: auto;
            z-index: 1000; display: none; box-shadow: var(--shadow-lg); }
        .dropdown-list.show { display: block; }
        .dropdown-item { padding: 14px 16px; cursor: pointer; border-bottom: 1px solid var(--border-subtle); }
        .dropdown-item:hover { background: rgba(99, 102, 241, 0.05); }
        .dropdown-item-name { font-weight: 600; margin-bottom: 2px; }
        .dropdown-item-product { font-size: 0.8rem; color: var(--text-muted); }

        .rank-toggle { display: flex; background: #f1f5f9; padding: 4px; border-radius: var(--radius-md); margin-bottom: 20px; }
        .rank-toggle-btn { flex: 1; padding: 10px 12px; background: transparent; border: none; border-radius: 8px;
            color: var(--text-muted); font-size: 0.8rem; font-weight: 600; cursor: pointer; }
        .rank-toggle-btn.active { background: white; color: var(--accent-primary); }
        .rank-tabs { display: flex; gap: 4px; margin-bottom: 20px; }
        .rank-tab { flex: 1; padding: 10px; background: transparent; border: none; border-bottom: 2px solid transparent;
            color: var(--text-muted); font-size: 0.85rem; font-weight: 500; cursor: pointer; }
        .rank-tab.active { color: var(--accent-primary); border-bottom-color: var(--accent-primary); }
        .rank-list { max-height: 280px; overflow-y: auto; }
        .rank-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 12px;
            border-radius: var(--radius-md); margin-bottom: 8px; background: white; border: 1px solid transparent; }
        .rank-item:hover { background: rgba(99, 102, 241, 0.06); border-color: rgba(99, 102, 241, 0.15); transform: translateX(4px); }
        .rank-left { display: flex; align-items: center; gap: 12px; }
        .rank-medal { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 1rem; font-weight: 700; color: var(--text-muted); }
        .rank-medal.gold { background: linear-gradient(135deg, #fbbf24, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.3rem; }
        .rank-medal.silver { background: linear-gradient(135deg, #e5e7eb, #9ca3af); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.2rem; }
        .rank-medal.bronze { background: linear-gradient(135deg, #d97706, #b45309); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.1rem; }
        .rank-info-name { font-weight: 600; font-size: 0.9rem; }
        .rank-info-product { font-size: 0.75rem; color: var(--text-muted); }
        .rank-value { font-family: 'Outfit', sans-serif; font-weight: 700; color: var(--accent-secondary); }

        .activity-section { margin-top: 28px; padding-top: 24px; border-top: 1px solid var(--border-subtle); }
        .activity-title { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 16px; }
        .activity-feed { max-height: 200px; overflow-y: auto; }
        .activity-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-subtle); font-size: 0.85rem; }
        .activity-time { color: var(--text-muted); font-size: 0.75rem; margin-right: 8px; }

        .admin-section { margin-top: 48px; padding: 24px; background: white; border: 1px dashed var(--border-default); border-radius: var(--radius-xl); }
        .admin-title { font-size: 0.9rem; font-weight: 600; color: var(--text-muted); text-align: center; margin-bottom: 20px; }
        .admin-buttons { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .admin-btn { padding: 10px 18px; background: #f8fafc; border: 1px solid var(--border-default); border-radius: var(--radius-md);
            color: var(--text-secondary); font-size: 0.8rem; font-weight: 500; cursor: pointer; }
        .admin-btn:hover { background: white; border-color: rgba(99, 102, 241, 0.3); color: var(--accent-primary); }
        .admin-btn.danger { border-color: rgba(239, 68, 68, 0.3); color: var(--danger); }
        .admin-btn.success { border-color: rgba(16, 185, 129, 0.3); color: var(--success); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px); z-index: 9999; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-card { width: 100%; max-width: 480px; max-height: 90vh; overflow-y: auto; background: white;
            border-radius: var(--radius-xl); padding: 32px; position: relative; }
        .modal-close { position: absolute; top: 20px; right: 20px; width: 32px; height: 32px; background: #f1f5f9;
            border: none; border-radius: 8px; color: var(--text-muted); font-size: 1.2rem; cursor: pointer; }
        .modal-title { font-family: 'Outfit', sans-serif; font-size: 1.5rem; font-weight: 700; margin-bottom: 24px;
            background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .modal-list { list-style: none; }
        .modal-list li { padding: 12px 0; border-bottom: 1px solid var(--border-subtle); color: var(--text-secondary); font-size: 0.9rem; }
        .modal-list li strong { color: var(--text-primary); }

        .login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .login-container { width: 100%; max-width: 520px; text-align: center; }
        .login-title { font-family: 'Outfit', sans-serif; font-size: clamp(2.2rem, 7vw, 3.5rem); font-weight: 800;
            background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 16px; }
        .login-subtitle { color: var(--text-secondary); font-size: 1.1rem; margin-bottom: 40px; }
        .login-card { background: var(--bg-card); backdrop-filter: blur(20px); border: 1px solid var(--border-default);
            border-radius: var(--radius-xl); padding: 36px; box-shadow: var(--shadow-lg); }
        .login-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .login-card-title { font-size: 1.1rem; font-weight: 600; }
        .manage-btn { padding: 6px 12px; background: transparent; border: 1px solid var(--border-subtle);
            border-radius: 8px; color: var(--text-muted); font-size: 0.75rem; cursor: pointer; }
        .manage-btn:hover, .manage-btn.active { border-color: var(--warning); color: var(--warning); }
        .user-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px; }
        @media (max-width: 480px) { .user-grid { grid-template-columns: 1fr; } }
        .user-card { background: white; border: 1px solid var(--border-subtle); border-radius: var(--radius-md);
            padding: 18px; cursor: pointer; transition: var(--transition-base); position: relative; text-align: center; }
        .user-card:hover { border-color: rgba(99, 102, 241, 0.3); transform: translateY(-4px); }
        .user-card.selected { border-color: var(--accent-primary); background: rgba(99, 102, 241, 0.08); }
        .user-card-name { font-weight: 600; margin-bottom: 4px; }
        .user-card-product { font-size: 0.8rem; color: var(--text-muted); }
        .user-delete-btn { position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: var(--danger);
            border: none; border-radius: 50%; color: white; font-size: 0.8rem; cursor: pointer; }
        .login-register-link { color: var(--text-muted); font-size: 0.9rem; cursor: pointer; margin-top: 16px; }
        .login-register-link:hover { color: var(--accent-secondary); }

        .loading-msg { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .error-msg { text-align: center; padding: 20px; color: var(--danger); background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-md); }

        .level-info-grid { display: grid; gap: 12px; margin-top: 20px; }
        .level-info-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: var(--radius-md); }
        .level-info-item.current { background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.08)); border: 1px solid rgba(99, 102, 241, 0.3); }
        .level-info-emoji { font-size: 1.8rem; }
        .level-info-details { flex: 1; }
        .level-info-name { font-weight: 600; font-size: 0.9rem; }
        .level-info-req { font-size: 0.75rem; color: var(--text-muted); }

        .review-section { background: #f8fafc; border-radius: var(--radius-md); padding: 20px; margin-bottom: 16px; }
        .review-section h3 { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 16px; }
        .review-rank-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-subtle); font-size: 0.9rem; }
        .review-rank-item:last-child { border-bottom: none; }
        .review-total { background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.08)); border-radius: var(--radius-md); padding: 20px; text-align: center; }
        .review-total-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px; }
        .review-total-value { font-family: 'Outfit', sans-serif; font-size: 2.5rem; font-weight: 800; background: var(--gradient-gold); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .levelup-celebration { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8);
            display: flex; align-items: center; justify-content: center; z-index: 10000; animation: celebrationFade 0.5s ease; }
        @keyframes celebrationFade { from { opacity: 0; } to { opacity: 1; } }
        .levelup-content { text-align: center; animation: celebrationPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        @keyframes celebrationPop { from { transform: scale(0.3); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .levelup-emoji { font-size: 8rem; margin-bottom: 20px; animation: emojiSpin 1s ease-out; }
        @keyframes emojiSpin { from { transform: rotateY(0deg); } to { transform: rotateY(360deg); } }
        .levelup-text { font-family: 'Outfit', sans-serif; font-size: 2.5rem; font-weight: 800; color: white; margin-bottom: 10px; }
        .levelup-level { font-size: 1.5rem; color: #fbbf24; font-weight: 600; }

        #adminGoalParams { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-subtle); display: none; }
        #adminGoalParams input { width: 120px; padding: 8px 12px; margin-right: 10px; }
        #currencyEditArea { margin-top: 20px; padding: 20px; background: #f8fafc; border-radius: var(--radius-md); display: none; }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>

    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <h1 class="login-title">AG 43ê¸°<br>ê°€ì¹˜ í† í° GAME</h1>
            <p class="login-subtitle">ë‹¹ì‹ ì˜ ê°€ì¹˜ë¥¼ ì¦ëª…í•˜ê³  ì¸ì •ë°›ìœ¼ì„¸ìš”</p>
            <div id="userListArea" class="login-card">
                <div class="login-card-header">
                    <h3 class="login-card-title">ğŸ‘¤ ì°¸ê°€ì ì„ íƒ</h3>
                    <button class="manage-btn" id="adminToggleBtn" onclick="toggleAdminMode()">âš™ï¸ ê´€ë¦¬</button>
                </div>
                <div id="userGrid" class="user-grid"><div class="loading-msg">â³ ë°ì´í„° ë¡œë”© ì¤‘...</div></div>
                <button class="btn btn-primary" id="startBtn" onclick="startGame()" disabled>ì„ íƒí•œ ê³„ì •ìœ¼ë¡œ ì‹œì‘</button>
                <p class="login-register-link" onclick="toggleRegister()">â• ë‚´ ì´ë¦„ì´ ì—†ë‚˜ìš”? ìƒˆë¡œ ë“±ë¡í•˜ê¸°</p>
            </div>
            <div id="registerArea" class="login-card" style="display:none;">
                <h3 class="login-card-title" style="margin-bottom:24px;">âœ¨ ìƒˆ ì°¸ê°€ì ë“±ë¡</h3>
                <div class="form-group"><input type="text" id="regName" placeholder="ì´ë¦„ (ì˜ˆ: ê¹€ì„±ì¥)"></div>
                <div class="form-group"><input type="text" id="regProduct" placeholder="ì œê³µ ê°€ì¹˜ (ì˜ˆ: ê¸ì • ì—ë„ˆì§€)"></div>
                <button class="btn btn-primary" onclick="registerUser()">ë“±ë¡í•˜ê³  ì‹œì‘</button>
                <p class="login-register-link" onclick="toggleRegister()">ğŸ”™ ëŒì•„ê°€ê¸°</p>
            </div>
        </div>
    </div>

    <div id="gameScreen" class="container" style="display:none;">
        <div class="header">
            <h1>AG 43ê¸° ê°€ì¹˜ í† í° GAME</h1>
            <div class="header-actions">
                <button class="header-btn" onclick="openGuide()">ğŸ“– ê°€ì´ë“œ</button>
                <button class="header-btn" onclick="openLevelInfo()">ğŸ† ë ˆë²¨ ì •ë³´</button>
                <button class="header-btn" onclick="openWeeklyReview()">ğŸ“Š ì£¼ê°„ ë¦¬ë·°</button>
                <button class="header-btn" onclick="logout()">ğŸ”“ ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="ecosystem-card">
            <div class="eco-label">ğŸŒ AG 43ê¸° ìƒíƒœê³„ ì´ ìœ í†µëŸ‰</div>
            <div class="eco-value" id="totalEcosystem">0ë§Œì›</div>
            <div class="eco-target">ğŸ¯ ëª©í‘œ: <span id="targetGoalDisplay">1ì–µ</span> ë‹¬ì„±ê¹Œì§€ <span id="remainTarget">0</span>ë§Œì› ë‚¨ìŒ</div>
            <div id="adminGoalParams"><input type="number" id="newGoalInput" placeholder="ìƒˆ ëª©í‘œ (ë§Œ)"><button class="manage-btn" onclick="saveNewGoal()">ì €ì¥</button></div>
        </div>

        <div class="main-grid">
            <div>
                <div class="card profile-card">
                    <div class="profile-emoji" id="myEmoji">ğŸŒ±</div>
                    <div class="profile-name" id="myName">ì´ë¦„</div>
                    <span class="profile-badge" id="myLevel">Lv.1 ìƒˆì‹¹</span>
                    <div class="progress-section">
                        <div class="progress-label"><span>ê²½í—˜ì¹˜</span><span id="expPercent">0%</span></div>
                        <div class="progress-bar"><div class="progress-fill" id="expBar"></div></div>
                        <div class="next-level-text" id="nextLevelText">ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ 100ë§Œì›</div>
                    </div>
                    <div class="mission-box">
                        <div class="mission-item">
                            <div class="mission-label"><span>ğŸ“… ì˜¤ëŠ˜ ë°œí–‰</span><span id="dailyText">0ë§Œ</span></div>
                            <div class="mission-bar"><div class="mission-fill daily" id="dailyBar"></div></div>
                        </div>
                        <div class="mission-item">
                            <div class="mission-label"><span>ğŸ“† ì£¼ê°„ ë°œí–‰</span><span id="weeklyText">0ë§Œ</span></div>
                            <div class="mission-bar"><div class="mission-fill weekly" id="weeklyBar"></div></div>
                        </div>
                    </div>
                </div>
                <div class="card pending-card">
                    <div class="pending-header"><div class="pending-icon">ğŸ’°</div><div class="pending-title">ë°›ê¸° ëŒ€ê¸°</div></div>
                    <div class="pending-amount" id="pendingAmount">0ë§Œì›</div>
                    <div class="pending-list" id="pendingList"></div>
                    <button class="btn btn-receive" id="receiveBtn" onclick="receiveAll()" disabled>ğŸ™ ê°ì‚¬íˆ ë°›ê¸°</button>
                </div>
            </div>

            <div class="card">
                <div class="card-title"><div class="card-title-icon">ğŸ</div>ê°€ì¹˜ ì¸ì • í† í° ë°œí–‰</div>
                <form onsubmit="issueToken(event)">
                    <div class="form-group">
                        <label class="form-label">ëˆ„êµ¬ì˜ ê°€ì¹˜ë¥¼ ì¸ì •í•˜ë‚˜ìš”?</label>
                        <input type="hidden" id="targetUserId">
                        <div class="dropdown-wrapper">
                            <div class="dropdown-btn" onclick="toggleDropdown()"><span id="targetName">ì„ íƒí•˜ì„¸ìš”</span><span>â–¼</span></div>
                            <div class="dropdown-list" id="userDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ê¸ˆì•¡ ì„ íƒ (ë§Œì›)</label>
                        <div class="amount-grid">
                            <div class="amount-btn" onclick="selectAmount(5,event)">5ë§Œ</div>
                            <div class="amount-btn" onclick="selectAmount(10,event)">10ë§Œ</div>
                            <div class="amount-btn" onclick="selectAmount(20,event)">20ë§Œ</div>
                            <div class="amount-btn" onclick="selectAmount(50,event)">50ë§Œ</div>
                        </div>
                        <input type="number" id="customAmount" placeholder="ì§ì ‘ ì…ë ¥" style="margin-top:12px;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì–´ë–¤ ì ì´ í›Œë¥­í–ˆë‚˜ìš”?</label>
                        <textarea id="message" placeholder="ì¹­ì°¬í•´ì£¼ì„¸ìš”! âœ¨"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">ğŸª™ í† í° ë°œí–‰í•˜ê¸°</button>
                </form>
            </div>

            <div class="card">
                <div class="card-title"><div class="card-title-icon">ğŸ†</div>ëª…ì˜ˆì˜ ì „ë‹¹</div>
                <div class="rank-toggle">
                    <button class="rank-toggle-btn active" onclick="switchRankMode('energy')" id="btn-energy">Energy Maker</button>
                    <button class="rank-toggle-btn" onclick="switchRankMode('token')" id="btn-token">Token Maker</button>
                </div>
                <div class="rank-tabs">
                    <button class="rank-tab active" onclick="switchTab('weekly')" id="tab-weekly">ì£¼ê°„</button>
                    <button class="rank-tab" onclick="switchTab('monthly')" id="tab-monthly">ì›”ê°„</button>
                    <button class="rank-tab" onclick="switchTab('total')" id="tab-total">ëˆ„ì </button>
                </div>
                <div class="rank-list" id="rankingList"></div>
                <div class="activity-section">
                    <div class="activity-title">ğŸ“¡ ì‹¤ì‹œê°„ í™œë™</div>
                    <div class="activity-feed" id="activityFeed"></div>
                </div>
            </div>
        </div>

        <div class="admin-section">
            <div class="admin-title">ğŸ› ï¸ ìš´ì˜ì§„ ë©”ë‰´</div>
            <div class="admin-buttons">
                <button class="admin-btn" onclick="toggleGoalEdit()">ğŸ¯ ëª©í‘œ ì„¤ì •</button>
                <button class="admin-btn" onclick="openCurrencyControl()">ğŸ’¸ í†µí™”ëŸ‰ ì¡°ì ˆ</button>
                <button class="admin-btn" onclick="adminReset('weekly')">ğŸ“… ì£¼ê°„ ì´ˆê¸°í™”</button>
                <button class="admin-btn danger" onclick="adminReset('all')">ğŸ’€ ì‹œì¦Œ ì´ˆê¸°í™”</button>
                <button class="admin-btn success" onclick="downloadBackupData()">ğŸ“¥ ë°±ì—…</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="guideModal">
        <div class="modal-card">
            <button class="modal-close" onclick="closeGuide()">Ã—</button>
            <div class="modal-title">AG 43ê¸° ê°€ì¹˜ í† í° GAME</div>
            <ul class="modal-list">
                <li><strong>í•„ìˆ˜ ë¯¸ì…˜:</strong> ê°€ì¹˜ ì¸ì • í† í° ë°œí–‰í•˜ê¸°</li>
                <li><strong>ì‹œì¦Œ ëª©í‘œ:</strong> 43ê¸° ìƒíƒœê³„ í†µí™”ëŸ‰ 1ì–µ ì´ìƒ ë‹¬ì„±! ğŸš€</li>
                <li>ë°›ì€ í† í°ì€ "ê°ì‚¬íˆ ë°›ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ ìˆ˜ë ¹í•˜ì„¸ìš”!</li>
                <li><strong>ğŸ† ë ˆë²¨ ì‹œìŠ¤í…œ:</strong> í† í°ì„ ë°›ìœ¼ë©´ ê²½í—˜ì¹˜ê°€ ì˜¬ë¼ê°‘ë‹ˆë‹¤! (10ë ˆë²¨ê¹Œì§€)</li>
            </ul>
            <button class="btn btn-primary" onclick="closeGuide()" style="margin-top:24px;">Game Start ğŸ”¥</button>
        </div>
    </div>

    <div class="modal-overlay" id="levelModal">
        <div class="modal-card">
            <button class="modal-close" onclick="closeLevelInfo()">Ã—</button>
            <div class="modal-title">ğŸ† ë ˆë²¨ ì‹œìŠ¤í…œ</div>
            <p style="color:var(--text-secondary);margin-bottom:16px;font-size:0.9rem;">í† í°ì„ ë°›ì•„ ê²½í—˜ì¹˜ë¥¼ ìŒ“ê³  ë ˆë²¨ì—…í•˜ì„¸ìš”!</p>
            <div class="level-info-grid" id="levelInfoGrid"></div>
        </div>
    </div>

    <div class="modal-overlay" id="reviewModal">
        <div class="modal-card">
            <button class="modal-close" onclick="closeWeeklyReview()">Ã—</button>
            <div class="modal-title">ğŸ“… ì£¼ê°„ ë¦¬í¬íŠ¸</div>
            <div class="review-section"><h3>ğŸ’– Energy Maker (Top 3)</h3><div id="reviewEnergyRank"></div></div>
            <div class="review-section"><h3>ğŸª™ Token Maker (Top 3)</h3><div id="reviewTokenRank"></div></div>
            <div class="review-total"><div class="review-total-label">ì´ë²ˆ ì£¼ ì´ ìœ í†µ ê°€ì¹˜</div><div class="review-total-value" id="reviewTotalEco">0ë§Œì›</div></div>
            <button class="btn btn-primary" onclick="closeWeeklyReview()" style="margin-top:24px;">ê³„ì† ë‹¬ë ¤ë´ìš” ğŸš€</button>
        </div>
    </div>

    <div class="modal-overlay" id="currencyModal">
        <div class="modal-card">
            <button class="modal-close" onclick="closeCurrencyControl()">Ã—</button>
            <div class="modal-title">ğŸ’¸ í†µí™”ëŸ‰ ì¡°ì ˆ</div>
            <div class="form-group">
                <label class="form-label">ëŒ€ìƒ ìœ ì € ì„ íƒ</label>
                <div class="dropdown-wrapper">
                    <div class="dropdown-btn" onclick="toggleAdminUserDropdown()"><span id="adminTargetName">ì„ íƒí•˜ì„¸ìš”</span><span>â–¼</span></div>
                    <div class="dropdown-list" id="adminUserDropdown"></div>
                </div>
            </div>
            <div id="currencyEditArea">
                <div class="form-group"><label class="form-label">ëˆ„ì  ìˆ˜ë ¹ì•¡ (ì´ ìœ í†µëŸ‰ ë°˜ì˜)</label><input type="number" id="editTotalReceived"></div>
                <div class="form-group"><label class="form-label">ì›”ê°„ ìˆ˜ë ¹ì•¡</label><input type="number" id="editMonthlyReceived"></div>
                <div class="form-group"><label class="form-label">ì£¼ê°„ ìˆ˜ë ¹ì•¡</label><input type="number" id="editWeeklyReceived"></div>
                <div class="form-group"><label class="form-label">ëˆ„ì  ë°œí–‰ì•¡</label><input type="number" id="editTotalGiven"></div>
                <div class="form-group"><label class="form-label">ì›”ê°„ ë°œí–‰ì•¡</label><input type="number" id="editMonthlyGiven"></div>
                <div class="form-group"><label class="form-label">ì£¼ê°„ ë°œí–‰ì•¡</label><input type="number" id="editWeeklyGiven"></div>
                <div style="display:flex;gap:10px;margin-top:20px;">
                    <button class="btn btn-primary" onclick="saveCurrencyChanges()" style="flex:1;">ğŸ’¾ ì €ì¥</button>
                    <button class="btn" onclick="resetUserToZero()" style="flex:1;background:var(--danger);color:white;">ğŸ—‘ï¸ ì „ì²´ 0ìœ¼ë¡œ</button>
                </div>
            </div>
        </div>
    </div>

<script>
const SUPABASE_URL = 'https://kyicedypelnrnctkvicq.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt5aWNlZHlwZWxucm5jdGt2aWNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MDgzMDIsImV4cCI6MjA3OTQ4NDMwMn0.F-VjGyl14XQ-TLrTswi_3Ehbe1XezpRmHTkz4lJ2sT8';
let sbClient;
try { sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) { document.getElementById('userGrid').innerHTML = '<div class="error-msg">ì—°ê²° ì‹¤íŒ¨</div>'; }

let currentUser = null, allUsers = [], currentRankType = 'weekly', currentRankMode = 'energy', selectedAmt = 0, isAdminMode = false, ecosystemGoalAmount = 10000, tempUser = null;

// â­ í™•ì¥ëœ ë ˆë²¨ ì‹œìŠ¤í…œ (10ë‹¨ê³„)
const levels = [
    { min: 0, name: 'ìƒˆì‹¹', emoji: 'ğŸŒ±', desc: 'ì—¬ì •ì˜ ì‹œì‘' },
    { min: 100, name: 'ì„±ì¥', emoji: 'ğŸŒ¿', desc: 'ì‹¹ì´ íŠ¸ë‹¤' },
    { min: 300, name: 'ìˆ™ë ¨', emoji: 'ğŸŒ³', desc: 'ë¿Œë¦¬ë¥¼ ë‚´ë¦¬ë‹¤' },
    { min: 500, name: 'ì „ë¬¸', emoji: 'ğŸ’¼', desc: 'ì „ë¬¸ì„± ì¸ì •' },
    { min: 1000, name: 'ë§ˆìŠ¤í„°', emoji: 'ğŸ‘‘', desc: 'ë¶„ì•¼ì˜ ì™•' },
    { min: 2000, name: 'ì„¤ê³„ì', emoji: 'ğŸ—ï¸', desc: 'ì‹œìŠ¤í…œì„ êµ¬ì¶•í•˜ë‹¤' },
    { min: 3500, name: 'ì´‰ë§¤ì', emoji: 'ğŸ”¥', desc: 'ë³€í™”ë¥¼ ì í™”í•˜ë‹¤' },
    { min: 5000, name: 'í•­í•´ì‚¬', emoji: 'ğŸ§­', desc: 'ë°©í–¥ì„ ì œì‹œí•˜ë‹¤' },
    { min: 7500, name: 'í˜„ì', emoji: 'ğŸ¦‰', desc: 'ì§€í˜œë¥¼ ë‚˜ëˆ„ë‹¤' },
    { min: 10000, name: 'ì „ì„¤', emoji: 'â­', desc: 'ì‚´ì•„ìˆëŠ” ë ˆì „ë“œ' }
];

async function init() {
    try {
        await checkSystemAutoReset(); await fetchUsers(); setupRealtime();
        const savedId = localStorage.getItem('ag43_user_id');
        if (savedId) { const user = allUsers.find(u => u.user_id === savedId); if (user) { tempUser = user; startGame(false); } else { document.getElementById('loginScreen').style.display = 'flex'; } }
        else { document.getElementById('loginScreen').style.display = 'flex'; }
    } catch (err) { document.getElementById('userGrid').innerHTML = '<div class="error-msg">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>'; }
}

function setupRealtime() {
    sbClient.channel('public:user_data').on('postgres_changes', { event: '*', schema: 'public', table: 'user_data' }, () => fetchUsers(true)).subscribe();
    sbClient.channel('public:activities').on('postgres_changes', { event: '*', schema: 'public', table: 'activities' }, (payload) => { loadActivities(); if (payload.eventType === 'INSERT' && currentUser && (payload.new.user_id === currentUser.user_id || payload.new.message.includes(currentUser.name))) loadMyData(); }).subscribe();
}

async function fetchUsers(silent = false) {
    const { data, error } = await sbClient.from('user_data').select('*').neq('user_id', 'SYSTEM_CONFIG');
    if (error) return; allUsers = data || [];
    if (!silent) renderUserSelection(); renderRanking(); renderDropdown(); updateEcosystem();
    if (currentUser) { const u = allUsers.find(u => u.user_id === currentUser.user_id); if (u) { currentUser = u; updateMyUI(); } }
}

function renderUserSelection() {
    const grid = document.getElementById('userGrid');
    if (allUsers.length === 0) { grid.innerHTML = '<div class="loading-msg">ğŸ‘‹ ë“±ë¡ëœ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
    grid.innerHTML = '';
    allUsers.sort((a,b) => a.name.localeCompare(b.name)).forEach(u => {
        const div = document.createElement('div'); div.className = 'user-card';
        if (isAdminMode) div.style.borderColor = 'var(--warning)';
        let deleteBtn = isAdminMode ? `<button class="user-delete-btn" onclick="deleteUser('${u.user_id}','${u.name}');event.stopPropagation();">Ã—</button>` : '';
        div.innerHTML = `${deleteBtn}<div class="user-card-name">${u.name}</div><div class="user-card-product">${u.product}</div>`;
        div.onclick = () => { if (isAdminMode) editUser(u.user_id, u.name, u.product); else selectLoginUser(u, div); };
        grid.appendChild(div);
    });
}

async function checkSystemAutoReset() {
    let { data: config } = await sbClient.from('user_data').select('*').eq('user_id', 'SYSTEM_CONFIG').single();
    if (!config) { const init = { user_id: 'SYSTEM_CONFIG', name: 'SYSTEM', product: JSON.stringify({ daily: 0, weekly: 0 }), received: 10000 }; await sbClient.from('user_data').insert(init); config = init; }
    const goal = config.received || 10000; document.getElementById('targetGoalDisplay').innerText = (goal/10000)>=1 ? `${goal/10000}ì–µ` : `${goal}ë§Œ`; ecosystemGoalAmount = goal;
    const now = new Date(); let ts; try { ts = JSON.parse(config.product); } catch(e) { ts = { daily: 0, weekly: 0 }; }
    const todayStr = now.toDateString(); if (ts.daily !== todayStr) { await sbClient.from('user_data').update({ daily_given: 0, daily_received: 0 }).neq('user_id', 'SYSTEM_CONFIG'); ts.daily = todayStr; await sbClient.from('user_data').update({ product: JSON.stringify(ts) }).eq('user_id', 'SYSTEM_CONFIG'); }
}

function selectLoginUser(user, el) { tempUser = user; document.querySelectorAll('.user-card').forEach(e => e.classList.remove('selected')); el.classList.add('selected'); document.getElementById('startBtn').disabled = false; document.getElementById('startBtn').innerText = `[${user.name}] ë‹˜ìœ¼ë¡œ ì‹œì‘í•˜ê¸°`; }

async function startGame(showGuide = true) { if (!tempUser) return; currentUser = tempUser; localStorage.setItem('ag43_user_id', currentUser.user_id); document.getElementById('loginScreen').style.display = 'none'; document.getElementById('gameScreen').style.display = 'block'; loadMyData(); loadActivities(); if (showGuide) openGuide(); }

function logout() { if (confirm("ë¡œê·¸ì•„ì›ƒ?")) { localStorage.removeItem('ag43_user_id'); location.reload(); } }

async function loadMyData() {
    const { data: pendings } = await sbClient.from('pending_tokens').select('*').eq('to_user_id', currentUser.user_id);
    const total = (pendings || []).reduce((s, p) => s + p.amount, 0);
    document.getElementById('pendingAmount').innerText = `${total}ë§Œì›`; document.getElementById('receiveBtn').disabled = total === 0;
    document.getElementById('pendingList').innerHTML = (pendings || []).map(p => `<div style="padding:4px 0;border-bottom:1px solid var(--border-subtle);">â€¢ ${p.from_name}ë‹˜: ${p.amount}ë§Œì›</div>`).join('');
    updateMyUI();
}

function updateMyUI() {
    if (!currentUser) return;
    const score = currentUser.received || 0;
    let myLvl = levels[0], myLvlIdx = 0;
    for (let i = 0; i < levels.length; i++) { if (score >= levels[i].min) { myLvl = levels[i]; myLvlIdx = i; } }
    document.getElementById('myEmoji').innerText = myLvl.emoji;
    document.getElementById('myName').innerText = currentUser.name;
    const badge = document.getElementById('myLevel');
    badge.innerText = `Lv.${myLvlIdx+1} ${myLvl.name}`;
    badge.className = 'profile-badge';
    if (myLvlIdx >= 5) badge.classList.add(`level-${myLvlIdx+1}`);
    
    let progress, nextText;
    if (myLvlIdx === levels.length - 1) { progress = 100; nextText = 'ğŸ‰ ìµœê³  ë ˆë²¨ ë‹¬ì„±!'; }
    else { const prevMin = levels[myLvlIdx].min, nextMin = levels[myLvlIdx+1].min; progress = Math.min(100, ((score-prevMin)/(nextMin-prevMin))*100); nextText = `ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ ${nextMin-score}ë§Œì›`; }
    document.getElementById('expBar').style.width = `${progress}%`;
    document.getElementById('expPercent').innerText = `${Math.round(progress)}%`;
    document.getElementById('nextLevelText').innerText = nextText;
    
    const dg = currentUser.daily_given||0, wg = currentUser.weekly_given||0;
    document.getElementById('dailyBar').style.width = `${Math.min(100,(dg/1000)*100)}%`; document.getElementById('dailyText').innerText = `${dg}ë§Œ`;
    document.getElementById('weeklyBar').style.width = `${Math.min(100,(wg/1000)*100)}%`; document.getElementById('weeklyText').innerText = `${wg}ë§Œ`;
}

function updateEcosystem() { const total = allUsers.filter(u=>u.user_id!=='SYSTEM_CONFIG').reduce((s,u)=>s+(u.received||0),0); document.getElementById('totalEcosystem').innerText = `${total.toLocaleString()}ë§Œì›`; const remain = ecosystemGoalAmount - total; document.getElementById('remainTarget').innerText = remain > 0 ? remain.toLocaleString() : "ë‹¬ì„± ì™„ë£Œ! ğŸ‰"; }

function checkLevelUp(oldScore, newScore) {
    let oldLv = 0, newLv = 0;
    for (let i = 0; i < levels.length; i++) { if (oldScore >= levels[i].min) oldLv = i; if (newScore >= levels[i].min) newLv = i; }
    if (newLv > oldLv) showLevelUpCelebration(levels[newLv], newLv + 1);
}

function showLevelUpCelebration(level, num) {
    const overlay = document.createElement('div'); overlay.className = 'levelup-celebration';
    overlay.innerHTML = `<div class="levelup-content"><div class="levelup-emoji">${level.emoji}</div><div class="levelup-text">ğŸ‰ LEVEL UP!</div><div class="levelup-level">Lv.${num} ${level.name}</div></div>`;
    overlay.onclick = () => overlay.remove();
    document.body.appendChild(overlay);
    setTimeout(() => overlay.remove(), 4000);
}

async function issueToken(e) {
    e.preventDefault();
    const targetId = document.getElementById('targetUserId').value;
    const customVal = document.getElementById('customAmount').value;
    const amount = customVal ? parseInt(customVal) : selectedAmt;
    const msg = document.getElementById('message').value;
    if (!targetId) return alert("ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”!");
    if (!amount || amount <= 0) return alert("ê¸ˆì•¡ì„ ì„ íƒí•˜ì„¸ìš”!");
    try {
        await sbClient.from('pending_tokens').insert({ to_user_id: targetId, from_user_id: currentUser.user_id, from_name: currentUser.name, amount, note: msg });
        await sbClient.from('user_data').update({ given: (currentUser.given||0)+amount, weekly_given: (currentUser.weekly_given||0)+amount, daily_given: (currentUser.daily_given||0)+amount, monthly_given: (currentUser.monthly_given||0)+amount }).eq('user_id', currentUser.user_id);
        const targetName = document.getElementById('targetName').innerText;
        await sbClient.from('activities').insert({ user_id: currentUser.user_id, message: `${currentUser.name}ë‹˜ì´ ${targetName}ë‹˜ì—ê²Œ ${amount}ë§Œì› ë°œí–‰!` });
        alert(`${amount}ë§Œì› ë°œí–‰ ì™„ë£Œ!`);
        document.getElementById('message').value = ''; document.getElementById('customAmount').value = ''; selectedAmt = 0;
        document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('selected'));
        currentUser.given = (currentUser.given||0)+amount; currentUser.weekly_given = (currentUser.weekly_given||0)+amount; currentUser.daily_given = (currentUser.daily_given||0)+amount;
        updateMyUI();
    } catch(err) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
}

async function receiveAll() {
    if (!confirm("ëª¨ë“  í† í°ì„ ìˆ˜ë ¹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    try {
        const { data: pendings } = await sbClient.from('pending_tokens').select('*').eq('to_user_id', currentUser.user_id);
        const total = (pendings || []).reduce((s,p)=>s+p.amount, 0);
        const oldScore = currentUser.received || 0;
        await sbClient.from('pending_tokens').delete().eq('to_user_id', currentUser.user_id);
        await sbClient.from('user_data').update({ received: oldScore+total, weekly_received: (currentUser.weekly_received||0)+total, daily_received: (currentUser.daily_received||0)+total, monthly_received: (currentUser.monthly_received||0)+total }).eq('user_id', currentUser.user_id);
        await sbClient.from('activities').insert({ user_id: currentUser.user_id, message: `${currentUser.name}ë‹˜ì´ ${total}ë§Œì›ì„ ê°ì‚¬íˆ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤! ğŸ’°` });
        checkLevelUp(oldScore, oldScore+total);
        alert(`${total}ë§Œì› ìˆ˜ë ¹ ì™„ë£Œ!`);
        currentUser.received = oldScore+total;
        loadMyData();
    } catch(err) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
}

function toggleDropdown() { document.getElementById('userDropdown').classList.toggle('show'); }
function renderDropdown() { const list = document.getElementById('userDropdown'); list.innerHTML = ''; allUsers.filter(u => u.user_id !== currentUser?.user_id).forEach(u => { const item = document.createElement('div'); item.className = 'dropdown-item'; item.innerHTML = `<div class="dropdown-item-name">${u.name}</div><div class="dropdown-item-product">${u.product}</div>`; item.onclick = () => { document.getElementById('targetUserId').value = u.user_id; document.getElementById('targetName').innerText = u.name; list.classList.remove('show'); }; list.appendChild(item); }); }
function selectAmount(amt, e) { selectedAmt = amt; document.getElementById('customAmount').value = ''; document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('selected')); if (e?.target) e.target.classList.add('selected'); }
function switchTab(type) { currentRankType = type; document.querySelectorAll('.rank-tab').forEach(b => b.classList.remove('active')); document.getElementById(`tab-${type}`).classList.add('active'); renderRanking(); }
function switchRankMode(mode) { currentRankMode = mode; document.getElementById('btn-energy').classList.toggle('active', mode==='energy'); document.getElementById('btn-token').classList.toggle('active', mode==='token'); renderRanking(); }

function renderRanking() {
    const list = document.getElementById('rankingList'); list.innerHTML = '';
    let sortKey = currentRankMode==='energy' ? (currentRankType==='weekly'?'weekly_given':currentRankType==='monthly'?'monthly_given':'given') : (currentRankType==='weekly'?'weekly_received':currentRankType==='monthly'?'monthly_received':'received');
    const sorted = [...allUsers].sort((a,b) => (b[sortKey]||0) - (a[sortKey]||0));
    sorted.forEach((u, idx) => { const val = u[sortKey]||0; if (val === 0 && idx > 2) return;
        const div = document.createElement('div'); div.className = 'rank-item'; let medalClass = '', medal = idx + 1;
        if (idx === 0) { medal = 'ğŸ¥‡'; medalClass = 'gold'; } else if (idx === 1) { medal = 'ğŸ¥ˆ'; medalClass = 'silver'; } else if (idx === 2) { medal = 'ğŸ¥‰'; medalClass = 'bronze'; }
        div.innerHTML = `<div class="rank-left"><span class="rank-medal ${medalClass}">${medal}</span><div><div class="rank-info-name">${u.name}</div><div class="rank-info-product">${u.product}</div></div></div><div class="rank-value">${val.toLocaleString()}ë§Œ</div>`;
        list.appendChild(div);
    });
}

function openLevelInfo() {
    document.getElementById('levelModal').style.display = 'flex';
    const grid = document.getElementById('levelInfoGrid');
    const score = currentUser?.received || 0;
    let currentLvl = 0; for (let i = 0; i < levels.length; i++) { if (score >= levels[i].min) currentLvl = i; }
    grid.innerHTML = levels.map((lvl, idx) => {
        const isCurrent = idx === currentLvl, isUnlocked = score >= lvl.min;
        return `<div class="level-info-item ${isCurrent?'current':''}" style="${!isUnlocked?'opacity:0.5;':''}"><div class="level-info-emoji">${lvl.emoji}</div><div class="level-info-details"><div class="level-info-name">Lv.${idx+1} ${lvl.name} ${isCurrent?'â† í˜„ì¬':''}</div><div class="level-info-req">${lvl.min===0?'ì‹œì‘':`${lvl.min.toLocaleString()}ë§Œì› ì´ìƒ`} Â· ${lvl.desc}</div></div></div>`;
    }).join('');
}
function closeLevelInfo() { document.getElementById('levelModal').style.display = 'none'; }

function openWeeklyReview() { 
    document.getElementById('reviewModal').style.display = 'flex'; 
    const topEnergy = [...allUsers].sort((a, b) => (b.weekly_given || 0) - (a.weekly_given || 0)).slice(0, 3); 
    document.getElementById('reviewEnergyRank').innerHTML = topEnergy.map((u, i) => `<div class="review-rank-item"><span>${i + 1}ìœ„ <strong>${u.name}</strong></span><span style="color:var(--warning);font-weight:600;">${u.weekly_given || 0}ë§Œ</span></div>`).join(''); 
    const topToken = [...allUsers].sort((a, b) => (b.weekly_received || 0) - (a.weekly_received || 0)).slice(0, 3); 
    document.getElementById('reviewTokenRank').innerHTML = topToken.map((u, i) => `<div class="review-rank-item"><span>${i + 1}ìœ„ <strong>${u.name}</strong></span><span style="color:var(--accent-secondary);font-weight:600;">${u.weekly_received || 0}ë§Œ</span></div>`).join(''); 
    const weeklyTotal = allUsers.reduce((sum, u) => sum + (u.weekly_given || 0), 0); 
    document.getElementById('reviewTotalEco').innerText = `${weeklyTotal.toLocaleString()}ë§Œì›`; 
}
function closeWeeklyReview() { document.getElementById('reviewModal').style.display = 'none'; }

let editingUserId = null;
function openCurrencyControl() { 
    const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:"); 
    if (pw !== 'admin0000') return alert("ì ‘ê·¼ ë¶ˆê°€"); 
    document.getElementById('currencyModal').style.display = 'flex'; 
    document.getElementById('currencyEditArea').style.display = 'none';
    renderAdminUserDropdown(); 
}
function closeCurrencyControl() { 
    document.getElementById('currencyModal').style.display = 'none'; 
    editingUserId = null; 
    document.getElementById('currencyEditArea').style.display = 'none'; 
    document.getElementById('adminTargetName').innerText = "ì„ íƒí•˜ì„¸ìš”"; 
}
function toggleAdminUserDropdown() { document.getElementById('adminUserDropdown').classList.toggle('show'); }
function renderAdminUserDropdown() { 
    const list = document.getElementById('adminUserDropdown'); 
    list.innerHTML = ''; 
    allUsers.filter(u => u.user_id !== 'SYSTEM_CONFIG').forEach(u => { 
        const item = document.createElement('div'); 
        item.className = 'dropdown-item'; 
        item.innerHTML = `<div class="dropdown-item-name">${u.name}</div><div class="dropdown-item-product">${u.product}</div>`; 
        item.onclick = () => { selectUserForCurrencyEdit(u); list.classList.remove('show'); }; 
        list.appendChild(item); 
    }); 
}
function selectUserForCurrencyEdit(user) { 
    editingUserId = user.user_id; 
    document.getElementById('adminTargetName').innerText = user.name; 
    document.getElementById('currencyEditArea').style.display = 'block'; 
    document.getElementById('editTotalReceived').value = user.received || 0; 
    document.getElementById('editMonthlyReceived').value = user.monthly_received || 0; 
    document.getElementById('editWeeklyReceived').value = user.weekly_received || 0; 
    document.getElementById('editTotalGiven').value = user.given || 0; 
    document.getElementById('editMonthlyGiven').value = user.monthly_given || 0; 
    document.getElementById('editWeeklyGiven').value = user.weekly_given || 0; 
}
async function saveCurrencyChanges() { 
    if (!editingUserId) return alert("ìœ ì €ë¥¼ ì„ íƒí•˜ì„¸ìš”"); 
    const updates = { 
        received: parseInt(document.getElementById('editTotalReceived').value) || 0, 
        monthly_received: parseInt(document.getElementById('editMonthlyReceived').value) || 0, 
        weekly_received: parseInt(document.getElementById('editWeeklyReceived').value) || 0, 
        given: parseInt(document.getElementById('editTotalGiven').value) || 0, 
        monthly_given: parseInt(document.getElementById('editMonthlyGiven').value) || 0, 
        weekly_given: parseInt(document.getElementById('editWeeklyGiven').value) || 0 
    }; 
    await sbClient.from('user_data').update(updates).eq('user_id', editingUserId); 
    alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); 
    closeCurrencyControl(); 
    fetchUsers(true); 
}
function resetUserToZero() { 
    if (!editingUserId) return; 
    if (!confirm("ì´ ìœ ì €ì˜ ëª¨ë“  ìˆ˜ì¹˜ë¥¼ 0ìœ¼ë¡œ ì´ˆê¸°í™”?")) return; 
    document.getElementById('editTotalReceived').value = 0; 
    document.getElementById('editMonthlyReceived').value = 0; 
    document.getElementById('editWeeklyReceived').value = 0; 
    document.getElementById('editTotalGiven').value = 0; 
    document.getElementById('editMonthlyGiven').value = 0; 
    document.getElementById('editWeeklyGiven').value = 0; 
}

async function loadActivities() { const { data } = await sbClient.from('activities').select('*').order('created_at', { ascending: false }).limit(20); const feed = document.getElementById('activityFeed'); feed.innerHTML = ''; if (data?.length) data.forEach(a => { const div = document.createElement('div'); div.className = 'activity-item'; const time = new Date(a.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); div.innerHTML = `<span><span class="activity-time">[${time}]</span> ${a.message}</span>`; feed.appendChild(div); }); else feed.innerHTML = '<div class="loading-msg">í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; }

function toggleRegister() { const list = document.getElementById('userListArea'), reg = document.getElementById('registerArea'); if (list.style.display === 'none') { list.style.display = 'block'; reg.style.display = 'none'; } else { list.style.display = 'none'; reg.style.display = 'block'; } }
async function registerUser() { const name = document.getElementById('regName').value, product = document.getElementById('regProduct').value; if (!name || !product) return alert("ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); const newId = 'user_' + Date.now(); await sbClient.from('user_data').insert({ user_id: newId, name, product }); alert("ë“±ë¡ ì™„ë£Œ!"); toggleRegister(); fetchUsers(); }
function openGuide() { document.getElementById('guideModal').style.display = 'flex'; }
function closeGuide() { document.getElementById('guideModal').style.display = 'none'; }
function toggleAdminMode() { isAdminMode = !isAdminMode; const btn = document.getElementById('adminToggleBtn'); btn.innerText = isAdminMode ? "âœ… ì™„ë£Œ" : "âš™ï¸ ê´€ë¦¬"; btn.classList.toggle('active', isAdminMode); renderUserSelection(); }
async function deleteUser(id, name) { if (!confirm(`${name} ì‚­ì œ?`)) return; const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:"); if (pw !== 'admin0000') return alert("ë¹„ë²ˆ í‹€ë¦¼"); await sbClient.from('user_data').delete().eq('user_id', id); await sbClient.from('pending_tokens').delete().eq('to_user_id', id); alert("ì‚­ì œë¨"); fetchUsers(); }
function toggleGoalEdit() { const div = document.getElementById('adminGoalParams'); div.style.display = div.style.display === 'none' ? 'block' : 'none'; }
async function saveNewGoal() { const val = parseInt(document.getElementById('newGoalInput').value); if (!val || val <= 0) return alert("ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”"); await sbClient.from('user_data').update({ received: val }).eq('user_id', 'SYSTEM_CONFIG'); alert("ëª©í‘œ ìˆ˜ì •ë¨"); location.reload(); }
async function editUser(id, oldName, oldProd) { const newName = prompt("ì´ë¦„:", oldName); if (newName === null) return; const newProd = prompt("ì§ì—…:", oldProd); if (newProd === null) return; await sbClient.from('user_data').update({ name: newName, product: newProd }).eq('user_id', id); alert("ìˆ˜ì •ë¨"); fetchUsers(); }
async function adminReset(type) { const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:"); if (type==='all' && pw!=='admin0000') return alert("ë¹„ë²ˆ í‹€ë¦¼"); if (type!=='all' && pw!=='aground') return alert("ë¹„ë²ˆ í‹€ë¦¼"); if (!confirm(`[${type}] ì´ˆê¸°í™”?`)) return; let updates = {}; if (type==='weekly') updates = { weekly_received:0, weekly_given:0, daily_received:0, daily_given:0 }; else if (type==='all') updates = { received:0, given:0, weekly_received:0, weekly_given:0, monthly_received:0, monthly_given:0, daily_received:0, daily_given:0 }; await sbClient.from('user_data').update(updates).neq('user_id','xxxx'); if (type==='all') { await sbClient.from('pending_tokens').delete().neq('id',0); await sbClient.from('activities').delete().neq('id',0); } alert("ì´ˆê¸°í™” ì™„ë£Œ"); fetchUsers(); }
async function downloadBackupData() { const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:"); if (pw !== 'admin0000') return alert("ë¹„ë²ˆ í‹€ë¦¼"); const { data: users } = await sbClient.from('user_data').select('*'); const { data: pendings } = await sbClient.from('pending_tokens').select('*'); const { data: activities } = await sbClient.from('activities').select('*'); const backup = { users, pendings, activities, date: new Date().toISOString() }; const blob = new Blob([JSON.stringify(backup,null,2)],{type:"application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `AG43_Backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); }

document.addEventListener('click', e => { if (!e.target.closest('.dropdown-wrapper')) document.querySelectorAll('.dropdown-list').forEach(d => d.classList.remove('show')); });
init();
</script>
</body>
</html>